name: Deploy VPR Async Infrastructure

on:
  push:
    branches:
      - main
    paths:
      - 'infra/careervp/**'
      - 'src/backend/careervp/**'
      - '.github/workflows/deploy-vpr-async.yml'
  pull_request:
    branches:
      - main
    paths:
      - 'infra/careervp/**'
      - 'src/backend/careervp/**'
  workflow_dispatch:

permissions:
  contents: read
  id-token: write  # Required for OIDC

env:
  PYTHON_VERSION: '3.12'
  NODE_VERSION: '20'
  AWS_REGION: us-east-1
  ENVIRONMENT: dev

jobs:
  lint-and-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install uv
        uses: astral-sh/setup-uv@v3
        with:
          version: "latest"
          enable-cache: false

      - name: Install dependencies
        working-directory: src/backend
        run: uv sync

      - name: Run ruff check
        working-directory: src/backend
        run: uv run ruff check careervp/

      - name: Run mypy
        working-directory: src/backend
        run: uv run mypy careervp/ --strict

      - name: Run unit tests
        working-directory: src/backend
        run: uv run pytest tests/unit/ -v

      - name: Run integration tests
        working-directory: src/backend
        run: uv run pytest tests/integration/ -v

  cdk-synth:
    needs: lint-and-test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
          cache-dependency-path: package-lock.json

      - name: Install Node dependencies
        run: npm ci

      - name: Install uv
        uses: astral-sh/setup-uv@v3
        with:
          version: "latest"
          enable-cache: false

      - name: Build Lambda code
        working-directory: src/backend
        run: make build

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE }}
          role-session-name: github-actions-vpr-async-synth-${{ github.sha }}
          aws-region: ${{ env.AWS_REGION }}

      - name: CDK Synth
        working-directory: infra
        run: npx cdk synth --all

      - name: Upload CloudFormation templates
        uses: actions/upload-artifact@v4
        with:
          name: cdk-templates
          path: infra/cdk.out/
          retention-days: 7

  cdk-deploy:
    needs: cdk-synth
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    environment: dev
    outputs:
      api_url: ${{ steps.stack-outputs.outputs.api_url }}
      queue_url: ${{ steps.stack-outputs.outputs.queue_url }}
      table_name: ${{ steps.stack-outputs.outputs.table_name }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
          cache-dependency-path: package-lock.json

      - name: Install Node dependencies
        run: npm ci

      - name: Download synth artifacts
        uses: actions/download-artifact@v4
        with:
          name: cdk-templates
          path: infra/cdk.out/

      - name: Install uv
        uses: astral-sh/setup-uv@v3
        with:
          version: "latest"
          enable-cache: false

      - name: Build Lambda code
        working-directory: src/backend
        run: make build

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE }}
          role-session-name: github-actions-vpr-async-deploy-${{ github.sha }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Clean up stuck changesets
        run: |
          STACK_NAME="CareerVpVprAsyncDev"
          echo "Checking for stuck changesets..."
          CHANGESETS=$(aws cloudformation list-change-sets \
            --stack-name "$STACK_NAME" \
            --query "Summaries[?Status==\`CREATE_IN_PROGRESS\` || Status==\`FAILED\`].ChangeSetName" \
            --output text 2>/dev/null || echo "")

          if [ -n "$CHANGESETS" ]; then
            echo "Found stuck changesets, cleaning up..."
            echo "$CHANGESETS" | tr '\t' '\n' | while read changeset; do
              if [ -n "$changeset" ]; then
                echo "  Deleting: $changeset"
                aws cloudformation delete-change-set \
                  --stack-name "$STACK_NAME" \
                  --change-set-name "$changeset" 2>/dev/null || true
              fi
            done
          else
            echo "No stuck changesets found."
          fi

      - name: Wait for stack stability
        run: |
          STACK_NAME="CareerVpVprAsyncDev"
          STATUS=$(aws cloudformation describe-stacks \
            --stack-name "$STACK_NAME" \
            --query "Stacks[0].StackStatus" \
            --output text 2>/dev/null || echo "NOT_FOUND")

          case "$STATUS" in
            *CREATE_IN_PROGRESS*|*UPDATE_IN_PROGRESS*)
              echo "Stack is $STATUS, waiting for completion..."
              aws cloudformation wait stack-create-complete --stack-name "$STACK_NAME" 2>/dev/null || \
              aws cloudformation wait stack-update-complete --stack-name "$STACK_NAME" 2>/dev/null || true
              ;;
            *FAILED*|*ROLLBACK*)
              echo "Stack is in failed state ($STATUS), deleting for clean deploy..."
              aws cloudformation delete-stack --stack-name "$STACK_NAME"
              echo "Waiting for stack deletion..."
              aws cloudformation wait stack-delete-complete --stack-name "$STACK_NAME" || true
              ;;
            *)
              echo "Stack status: $STATUS"
              ;;
          esac

      - name: Deploy VPR Async Stack
        working-directory: infra
        run: npx cdk deploy CareerVpVprAsyncDev --require-approval never --outputs-file cdk-outputs.json

      - name: Extract stack outputs
        id: stack-outputs
        working-directory: infra
        run: |
          if [ -f cdk-outputs.json ]; then
            API_URL=$(jq -r '.CareerVpVprAsyncDev.VPRApiUrl // ""' cdk-outputs.json)
            QUEUE_URL=$(jq -r '.CareerVpVprAsyncDev.VPRJobsQueueUrl // ""' cdk-outputs.json)
            TABLE_NAME=$(jq -r '.CareerVpVprAsyncDev.JobsTableName // ""' cdk-outputs.json)

            echo "api_url=$API_URL" >> $GITHUB_OUTPUT
            echo "queue_url=$QUEUE_URL" >> $GITHUB_OUTPUT
            echo "table_name=$TABLE_NAME" >> $GITHUB_OUTPUT

            echo "Stack Outputs:"
            echo "  API URL: $API_URL"
            echo "  Queue URL: $QUEUE_URL"
            echo "  Table Name: $TABLE_NAME"
          else
            echo "Warning: cdk-outputs.json not found"
          fi

      - name: Upload stack outputs
        uses: actions/upload-artifact@v4
        with:
          name: stack-outputs
          path: infra/cdk-outputs.json
          retention-days: 7

  e2e-test:
    needs: cdk-deploy
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install uv
        uses: astral-sh/setup-uv@v3
        with:
          version: "latest"
          enable-cache: false

      - name: Install test dependencies
        working-directory: src/backend
        run: uv sync

      - name: Download stack outputs
        uses: actions/download-artifact@v4
        with:
          name: stack-outputs
          path: ./

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE }}
          role-session-name: github-actions-vpr-async-e2e-${{ github.sha }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Run E2E tests
        working-directory: src/backend
        env:
          API_BASE_URL: ${{ needs.cdk-deploy.outputs.api_url }}
          AWS_REGION: ${{ env.AWS_REGION }}
        run: |
          if [ -f "../../cdk-outputs.json" ]; then
            echo "Stack outputs available for E2E tests"
            uv run pytest tests/e2e/test_vpr_async_polling.py -v
          else
            echo "Warning: Stack outputs not available, skipping E2E tests"
            exit 1
          fi

  dry-run:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
          cache-dependency-path: package-lock.json

      - name: Install Node dependencies
        run: npm ci

      - name: Install uv
        uses: astral-sh/setup-uv@v3
        with:
          version: "latest"
          enable-cache: false

      - name: Build Lambda code
        working-directory: src/backend
        run: make build

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE }}
          role-session-name: github-actions-vpr-async-dryrun-${{ github.sha }}
          aws-region: ${{ env.AWS_REGION }}

      - name: CDK Diff (Dry Run)
        working-directory: infra
        run: npx cdk diff CareerVpVprAsyncDev

      - name: Comment on PR
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const output = `#### VPR Async Stack CDK Diff ðŸ“Š

            **Push Event:** \`${{ github.event_name }}\`
            **Workflow:** \`${{ github.workflow }}\`
            **Stack:** \`CareerVpVprAsyncDev\`

            Check the workflow logs for detailed CDK diff output.`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            });
