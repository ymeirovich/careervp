name: Deploy

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy (dev, staging, prod)'
        required: true
        default: dev

permissions:
  contents: read
  deployments: write
  id-token: write  # Required for OIDC

env:
  PYTHON_VERSION: '3.13'
  NODE_VERSION: '22'
  AWS_REGION: 'us-east-1'

jobs:
  deploy-dev:
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    environment: dev
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
          cache-dependency-path: package-lock.json
      - name: Install Node dependencies
        run: npm ci
      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true
          cache-dependency-glob: '**/uv.lock'
      - name: Install Python
        run: uv python install ${{ env.PYTHON_VERSION }}
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE }}
          role-session-name: deploy-dev-${{ github.sha }}
          aws-region: ${{ env.AWS_REGION }}
      - name: Ensure SSM Parameter exists
        env:
          ANTHROPIC_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          if [ -n "$ANTHROPIC_KEY" ]; then
            aws ssm put-parameter \
              --name "/careervp/dev/anthropic-api-key" \
              --value "$ANTHROPIC_KEY" \
              --type SecureString \
              --overwrite
          else
            echo "::warning::ANTHROPIC_API_KEY secret not set. Checking if SSM parameter exists..."
            aws ssm get-parameter --name "/careervp/dev/anthropic-api-key" --query "Parameter.Name" --output text || \
              echo "::warning::SSM parameter /careervp/dev/anthropic-api-key not found. Set ANTHROPIC_API_KEY secret or create manually."
          fi
      - name: Build and Deploy
        working-directory: src/backend
        env:
          ENVIRONMENT: dev
        run: make deploy
      - name: Post-deploy smoke test
        working-directory: src/backend
        run: make smoke-test

  deploy-other:
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    environment:
      name: ${{ inputs.environment }}
      url: https://${{ inputs.environment }}.careervp.example.com
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
          cache-dependency-path: package-lock.json
      - name: Install Node dependencies
        run: npm ci
      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true
          cache-dependency-glob: '**/uv.lock'
      - name: Install Python
        run: uv python install ${{ env.PYTHON_VERSION }}
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE }}
          role-session-name: deploy-${{ inputs.environment }}-${{ github.sha }}
          aws-region: ${{ env.AWS_REGION }}
      - name: Ensure SSM Parameter exists
        env:
          ANTHROPIC_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          TARGET_ENV: ${{ inputs.environment }}
        run: |
          if [ -n "$ANTHROPIC_KEY" ]; then
            aws ssm put-parameter \
              --name "/careervp/${TARGET_ENV}/anthropic-api-key" \
              --value "$ANTHROPIC_KEY" \
              --type SecureString \
              --overwrite
          else
            echo "::warning::ANTHROPIC_API_KEY secret not set. Checking if SSM parameter exists..."
            aws ssm get-parameter --name "/careervp/${TARGET_ENV}/anthropic-api-key" --query "Parameter.Name" --output text || \
              echo "::warning::SSM parameter /careervp/${TARGET_ENV}/anthropic-api-key not found. Set ANTHROPIC_API_KEY secret or create manually."
          fi
      - name: Build and Deploy
        working-directory: src/backend
        env:
          ENVIRONMENT: ${{ inputs.environment }}
        run: make deploy
      - name: Post-deploy smoke test
        working-directory: src/backend
        env:
          ENVIRONMENT: ${{ inputs.environment }}
        run: make smoke-test
