name: Deploy

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy (dev, staging, prod)'
        required: true
        default: dev

# Concurrency control: prevents multiple deployments from running simultaneously
# on the same stack. New pushes will cancel in-progress runs.
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  deployments: write
  id-token: write  # Required for OIDC

env:
  PYTHON_VERSION: '3.13'
  NODE_VERSION: '22'
  AWS_REGION: 'us-east-1'
  UV_VERSION: '0.5.21'
  STACK_NAME: 'CareerVpCrudDev'

jobs:
  deploy-dev:
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    environment: dev
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
          cache-dependency-path: package-lock.json
      - name: Install Node dependencies
        run: npm ci
      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          version: ${{ env.UV_VERSION }}
          enable-cache: true
          cache-dependency-glob: '**/uv.lock'
      - name: Install Python
        run: uv python install ${{ env.PYTHON_VERSION }}
      - name: Install backend dependencies
        working-directory: src/backend
        run: uv sync
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE }}
          role-session-name: deploy-dev-${{ github.sha }}
          aws-region: ${{ env.AWS_REGION }}
      - name: Ensure SSM Parameter exists
        env:
          ANTHROPIC_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          if [ -n "$ANTHROPIC_KEY" ]; then
            aws ssm put-parameter \
              --name "/careervp/dev/anthropic-api-key" \
              --value "$ANTHROPIC_KEY" \
              --type SecureString \
              --overwrite
          else
            echo "::warning::ANTHROPIC_API_KEY secret not set. Checking if SSM parameter exists..."
            aws ssm get-parameter --name "/careervp/dev/anthropic-api-key" --query "Parameter.Name" --output text || \
              echo "::warning::SSM parameter /careervp/dev/anthropic-api-key not found. Set ANTHROPIC_API_KEY secret or create manually."
          fi
      - name: CFN State Guard
        run: |
          .github/scripts/cfn-guard.sh "${{ env.STACK_NAME }}" "${{ env.AWS_REGION }}"
      - name: Build and Deploy
        working-directory: src/backend
        env:
          ENVIRONMENT: dev
        run: make deploy
      - name: Wait for Stack Stability
        run: |
          echo "Waiting for CloudFormation stack to stabilize..."
          aws cloudformation wait stack-create-complete \
            --stack-name ${{ env.STACK_NAME }} \
            --region ${{ env.AWS_REGION }} 2>/dev/null || \
          aws cloudformation wait stack-update-complete \
            --stack-name ${{ env.STACK_NAME }} \
            --region ${{ env.AWS_REGION }} 2>/dev/null || true
      - name: Wait for API Availability
        run: |
          .github/scripts/wait-for-api.sh "${{ env.AWS_REGION }}" "${{ env.STACK_NAME }}"
      - name: Post-deploy smoke test
        run: |
          echo "=== API SMOKE TEST ==="
          API_URL="${{ env.STACK_NAME == 'CareerVpCrudDev' && 'https://4xe2tdq8z6.execute-api.us-east-1.amazonaws.com/prod/' || 'https://4xe2tdq8z6.execute-api.us-east-1.amazonaws.com/prod/' }}"
          echo "Testing: $API_URL"
          HTTP_CODE=$(curl -sf -o /dev/null -w "%{http_code}" "${API_URL}swagger")
          if [ "$HTTP_CODE" = "200" ]; then
            echo "PASS: API Gateway responding ($HTTP_CODE)"
          else
            echo "FAIL: API Gateway returned $HTTP_CODE"
            exit 1
          fi

  deploy-other:
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    environment:
      name: ${{ inputs.environment }}
      url: https://${{ inputs.environment }}.careervp.example.com
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
          cache-dependency-path: package-lock.json
      - name: Install Node dependencies
        run: npm ci
      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          version: ${{ env.UV_VERSION }}
          enable-cache: true
          cache-dependency-glob: '**/uv.lock'
      - name: Install Python
        run: uv python install ${{ env.PYTHON_VERSION }}
      - name: Install backend dependencies
        working-directory: src/backend
        run: uv sync
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE }}
          role-session-name: deploy-${{ inputs.environment }}-${{ github.sha }}
          aws-region: ${{ env.AWS_REGION }}
      - name: Ensure SSM Parameter exists
        env:
          ANTHROPIC_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          TARGET_ENV: ${{ inputs.environment }}
        run: |
          if [ -n "$ANTHROPIC_KEY" ]; then
            aws ssm put-parameter \
              --name "/careervp/${TARGET_ENV}/anthropic-api-key" \
              --value "$ANTHROPIC_KEY" \
              --type SecureString \
              --overwrite
          else
            echo "::warning::ANTHROPIC_API_KEY secret not set. Checking if SSM parameter exists..."
            aws ssm get-parameter --name "/careervp/${TARGET_ENV}/anthropic-api-key" --query "Parameter.Name" --output text || \
              echo "::warning::SSM parameter /careervp/${TARGET_ENV}/anthropic-api-key not found. Set ANTHROPIC_API_KEY secret or create manually."
          fi
      - name: CFN State Guard
        env:
          # Dynamically compute stack name for other environments
          STACK_NAME: ${{ inputs.environment == 'prod' && 'CareerVpCrudProduction' || inputs.environment == 'staging' && 'CareerVpCrudStaging' || 'CareerVpCrudDev' }}
        run: |
          .github/scripts/cfn-guard.sh "$STACK_NAME" "${{ env.AWS_REGION }}"
      - name: Build and Deploy
        working-directory: src/backend
        env:
          ENVIRONMENT: ${{ inputs.environment }}
        run: make deploy
      - name: Wait for Stack Stability
        env:
          STACK_NAME: ${{ inputs.environment == 'prod' && 'CareerVpCrudProduction' || inputs.environment == 'staging' && 'CareerVpCrudStaging' || 'CareerVpCrudDev' }}
        run: |
          echo "Waiting for CloudFormation stack to stabilize..."
          aws cloudformation wait stack-create-complete \
            --stack-name "$STACK_NAME" \
            --region ${{ env.AWS_REGION }} 2>/dev/null || \
          aws cloudformation wait stack-update-complete \
            --stack-name "$STACK_NAME" \
            --region ${{ env.AWS_REGION }} 2>/dev/null || true
      - name: Wait for API Availability
        env:
          STACK_NAME: ${{ inputs.environment == 'prod' && 'CareerVpCrudProduction' || inputs.environment == 'staging' && 'CareerVpCrudStaging' || 'CareerVpCrudDev' }}
        run: |
          .github/scripts/wait-for-api.sh "${{ env.AWS_REGION }}" "$STACK_NAME"
      - name: Post-deploy smoke test
        working-directory: src/backend
        env:
          ENVIRONMENT: ${{ inputs.environment }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          AUTO_SET_LAMBDA_ENV: '1'
        run: make smoke-test
