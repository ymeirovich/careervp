# CareerVP Coding & Workflow Rules

## Architecture & Style
- **Pattern:** Adhere strictly to the "Handler -> Logic -> DAL" separation.
- **Handlers:** Every Lambda handler MUST use AWS Lambda Powertools for logging, tracing, and metrics.
- **Types:** Python type hints are mandatory for all function signatures.
- **Errors:** Use a standard Result object pattern for cross-layer error communication.

## Feature Gatekeeping
- **Test-First:** Never mark a task as complete in `plan.md` until its corresponding unit test passes.
- **No Hallucinations:** When tailoring CVs, ensure the `Fact Verification System` rules are applied: Static facts (dates/titles) are IMMUTABLE.
- **Anti-AI:** All generated text must follow the 8-pattern avoidance framework (natural transitions, varied structure).

## Mandatory Test Creation

- Every logic module (`careervp/logic/*.py`) MUST have a corresponding test file in `tests/unit/`.
- Every handler (`careervp/handlers/*.py`) MUST have a corresponding test file in `tests/unit/`.
- Test files MUST use `moto` for AWS service mocking (DynamoDB, S3).
- Test files MUST mock external API calls (LLM, etc.) - never call real APIs in tests.
- Run `uv run pytest tests/unit/<test_file>.py -v` before marking any task complete.

## Documentation
- Before starting a new feature, read the corresponding spec in `docs/specs/`.
- Update `PROGRESS.md` and `plan.md` at the end of every successful task.

# Mandatory Type-Safety Guardrail

- After every Python file edit, you MUST execute: `uv run mypy <filename> --strict`
- If mypy returns errors, you are NOT allowed to present the code to the user.
- You must fix the type errors and re-run the check until it passes.

# Mandatory Lint Guardrail

- After every Python file edit, you MUST execute: `uv run ruff check <filename> --fix`
- Resolve all Ruff findings before sharing code or running other tasks.

## Mandatory Testing Rules

### Unit Tests (Required for Deployment)

- Every logic module (`careervp/logic/*.py`) MUST have a corresponding test file in `tests/unit/`.
- Every handler (`careervp/handlers/*.py`) MUST have a corresponding test file in `tests/unit/`.
- Test file naming: `test_<module_name>.py` (e.g., `test_vpr_generator.py`).
- Run tests with: `uv run pytest tests/unit/<test_file>.py -v`
- All tests MUST pass before marking any task complete.

### Mocking Requirements

- Use `moto` for AWS service mocking (DynamoDB, S3).
- Mock external API calls (LLM, HTTP) - NEVER call real APIs in tests.
- Use `unittest.mock.patch` for LLM client mocking.

### CI/CD Integration

- Pre-commit runs: `ruff check`, `ruff format --check`, `mypy --strict`
- Deployment pipeline runs: `pytest tests/unit/ -v --tb=short`
- Integration tests run on staging: `pytest tests/integration/ -v`

### Mandatory Cleanup

- Before completing any task: `uv run ruff format .` and `uv run ruff check --fix .`
- Zero linting errors required for task completion.

### Coverage Guidelines

- Target: 80%+ line coverage for logic modules.
- Critical paths (FVS validation, LLM parsing) require explicit test cases.
- Edge cases: empty inputs, invalid data, timeout scenarios.

## Section: Agent Escalation Protocol
The Engineer (Codex) Rule: If any specified Path, Class Name, or Method Signature in a Task Guide does not exist in the current environment, the Engineer MUST NOT create a workaround. They must emit a "BLOCKING ISSUE" report and exit.

## The Architect (Claude) Rule:
Upon a Blocking Issue, the Architect must analyze if the Spec is wrong or if the Environment needs refactoring. The Architect must provide a "Migration Path" in the next Task Guide.
